#!/usr/bin/env node
/**
Copyright: 2021 Contrast Security, Inc
  Contact: support@contrastsecurity.com
  License: Commercial

  NOTICE: This Software and the patented inventions embodied within may only be
  used as part of Contrast Securityâ€™s commercial offerings. Even though it is
  made available through public repositories, use of this Software is subject to
  the applicable End User Licensing Agreement found at
  https://www.contrastsecurity.com/enduser-terms-0317a or as otherwise agreed
  between Contrast Security and the End User. The Software may not be reverse
  engineered, modified, repackaged, sold, redistributed or otherwise used in a
  way not consistent with the End User License Agreement.
*/
const process = require('process');
const path = require('path');
const fs = require('fs');

function load() {
  cleanArgv();
  require('./loader.js');
  let PATH;

  // for local development
  if (fs.existsSync(`${__dirname + path.sep}lib`)) {
    PATH = './lib/contrast';
  } else {
    PATH = './lib.asar/contrast';
  }

  return require(PATH);
}

/**
 * TODO: Remove w/ release of v3.0.0.
 * We do this to prevent bad restart argument passed by buggy app-update code in
 * older agents. We filter out the known bad option iff if it is used as an
 * agent argument (occurrance is before -- in argument list).
 */
function cleanArgv() {
  process.argv = process.argv.filter((value) => {
    if (value === '--') {
      module.exports.seenDashDash = true;
      return true;
    }
    return value === '--agent.auto_update.enable false'
      ? module.exports.seenDashDash
      : true;
  });
}

module.exports = load();
module.exports.load = load;
module.exports.cleanArgv = cleanArgv;
module.exports.seenDashDash = false;
