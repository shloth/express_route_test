#!/usr/bin/env node
/**
Copyright: 2021 Contrast Security, Inc
  Contact: support@contrastsecurity.com
  License: Commercial

  NOTICE: This Software and the patented inventions embodied within may only be
  used as part of Contrast Securityâ€™s commercial offerings. Even though it is
  made available through public repositories, use of this Software is subject to
  the applicable End User Licensing Agreement found at
  https://www.contrastsecurity.com/enduser-terms-0317a or as otherwise agreed
  between Contrast Security and the End User. The Software may not be reverse
  engineered, modified, repackaged, sold, redistributed or otherwise used in a
  way not consistent with the End User License Agreement.
*/

const startTime = process.hrtime();

const Module = require('module');
const loader = require('./agent-loader');
const orig = Module.runMain;

/**
 * Calling contrast bootstrapping
 * process before invoking the main
 * script from cli
 */
Module.runMain = async function(...args) {
  const { enabled } = await loader.init(process.argv);

  if (enabled) {
    await loader.bootstrap(process.argv);
  }
  await loader.resetArgs(process.argv[0], process.argv[1]);

  loader.logTime(startTime, 'agent');

  const appStartTime = process.hrtime();
  orig.apply(this, args);
  loader.logTime(appStartTime, 'application');
  loader.logTime(startTime, 'agent & application');
};
